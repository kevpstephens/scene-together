# SceneTogether - Deployment Guide

This guide covers deploying the SceneTogether platform, which has been consolidated into a single **Expo React Native app** that works on mobile, web, and desktop.

## 🎯 Architecture Overview

- **Frontend**: Expo React Native (mobile + web)
- **Backend**: Express.js + Prisma + PostgreSQL
- **Database**: PostgreSQL (via Supabase)
- **Authentication**: Supabase Auth
- **External API**: TMDB (The Movie Database)

---

## 📱 Frontend Deployment (Expo Web)

The mobile app can be deployed as a **web application** using Expo's web build capabilities.

### Prerequisites

- Node.js 18+
- npm or pnpm
- Expo CLI (`npm install -g expo-cli`)

### Option 1: Deploy to Netlify (Recommended)

1. **Build the web app**:

   ```bash
   cd mobile
   npx expo export:web
   ```

   This creates a `web-build` directory with static files.

2. **Deploy to Netlify**:

   **Option A - Using Netlify CLI**:

   ```bash
   npm install -g netlify-cli
   netlify deploy --prod --dir=web-build
   ```

   **Option B - Using Netlify Dashboard**:
   - Go to [app.netlify.com](https://app.netlify.com)
   - Click "Add new site" → "Deploy manually"
   - Drag and drop the `web-build` folder

   **Option C - Connect to Git** (Best for continuous deployment):
   - Push your code to GitHub
   - In Netlify: "Add new site" → "Import from Git"
   - Select your repo
   - Build settings are automatically read from `netlify.toml`

3. **Environment Variables**:
   Set these in Netlify dashboard (Site settings → Environment variables):
   ```
   EXPO_PUBLIC_API_URL=https://your-backend-url.com
   EXPO_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
   EXPO_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
   ```

### Option 2: Deploy to Vercel

1. **Install Vercel CLI**:

   ```bash
   npm install -g vercel
   ```

2. **Deploy**:

   ```bash
   cd mobile
   vercel --prod
   ```

   Or connect to Git via [vercel.com](https://vercel.com) dashboard.

3. **Environment Variables**:
   Add in Vercel dashboard (Settings → Environment Variables).

### Option 3: Other Platforms

The `web-build` folder contains static files that can be deployed to:

- **GitHub Pages**: Copy `web-build` contents to your gh-pages branch
- **AWS S3 + CloudFront**: Upload to S3, configure CloudFront
- **Firebase Hosting**: `firebase deploy` after configuring
- **Cloudflare Pages**: Connect Git repo or upload manually

---

## 🖥️ Backend Deployment

### Option 1: Railway (Recommended - Free Tier Available)

1. **Create account** at [railway.app](https://railway.app)

2. **Deploy from GitHub**:
   - Click "New Project" → "Deploy from GitHub repo"
   - Select your repository
   - Choose the `api` directory as root

3. **Add PostgreSQL**:
   - Click "New" → "Database" → "Add PostgreSQL"
   - Railway auto-generates `DATABASE_URL`

4. **Environment Variables**:
   Set in Railway dashboard:

   ```
   DATABASE_URL=postgresql://... (auto-generated by Railway)
   JWT_SECRET=your-super-secret-jwt-key-change-this
   SUPABASE_URL=https://your-project.supabase.co
   SUPABASE_SERVICE_KEY=your-service-role-key
   PORT=3000
   NODE_ENV=production
   ```

5. **Run Migrations**:
   In Railway dashboard, run:
   ```bash
   npx prisma migrate deploy
   ```

### Option 2: Render

1. Go to [render.com](https://render.com)
2. Create new Web Service from Git
3. Select `api` directory
4. Build: `npm install && npx prisma generate`
5. Start: `npm start`
6. Add PostgreSQL database from Render dashboard
7. Set environment variables

### Option 3: Heroku

```bash
cd api
heroku create your-app-name
heroku addons:create heroku-postgresql:essential-0
heroku config:set JWT_SECRET=your-secret
git push heroku main
heroku run npx prisma migrate deploy
```

---

## 🗄️ Database Setup (Supabase)

1. **Create Supabase Project**:
   - Go to [supabase.com](https://supabase.com)
   - Create new project
   - Save your project URL and anon key

2. **Schema Setup**:
   The backend API uses Prisma, which will create tables automatically.

   For Supabase Auth to work:
   - Enable Email auth in Supabase dashboard
   - Configure email templates (optional)
   - Set up OAuth providers if needed (Google, etc.)

3. **Get Credentials**:
   - Project URL: `https://[your-project].supabase.co`
   - Anon Key: Found in Settings → API
   - Service Role Key: Found in Settings → API (keep secret!)

---

## 🔑 Environment Variables Setup

### Frontend (`mobile/`)

Create `.env` file (for local development):

```env
EXPO_PUBLIC_API_URL=http://localhost:3000
EXPO_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
EXPO_PUBLIC_SUPABASE_ANON_KEY=your-anon-key-here
```

For production (set in Netlify/Vercel dashboard):

```
EXPO_PUBLIC_API_URL=https://your-api-url.railway.app
EXPO_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
EXPO_PUBLIC_SUPABASE_ANON_KEY=your-anon-key-here
```

### Backend (`api/`)

Create `.env` file:

```env
DATABASE_URL="postgresql://user:password@host:5432/dbname"
JWT_SECRET="change-this-to-a-long-random-string"
SUPABASE_URL="https://your-project.supabase.co"
SUPABASE_SERVICE_KEY="your-service-role-key"
PORT=3000
NODE_ENV=development
```

---

## 📱 Running Locally

### 1. Start the Backend

```bash
cd api
npm install
npx prisma generate
npx prisma migrate dev
npm run dev
```

Backend runs on http://localhost:3000

### 2. Start the Mobile App

**For Web**:

```bash
cd mobile
npm install
npm run web
```

Opens http://localhost:8081

**For Mobile (Expo Go)**:

```bash
cd mobile
npm start
# Scan QR code with Expo Go app
```

**For iOS Simulator** (Mac only):

```bash
npm run ios
```

**For Android Emulator**:

```bash
npm run android
```

---

## 🎬 TMDB API Setup (Optional)

For movie data and posters:

1. Create account at [themoviedb.org](https://www.themoviedb.org/)
2. Go to Settings → API → Create API Key
3. Add to backend `.env`:
   ```
   TMDB_API_KEY=your-tmdb-api-key
   ```

---

## 🔐 Creating Admin Users

After deployment, you need to manually set user roles in the database:

### Option 1: Supabase Dashboard

1. Go to Supabase → Database → Table Editor
2. Find `users` table
3. Edit a user's `role` field to `ADMIN` or `SUPER_ADMIN`

### Option 2: SQL Query

```sql
UPDATE users
SET role = 'ADMIN'
WHERE email = 'admin@example.com';
```

### Option 3: Prisma Studio (Local)

```bash
cd api
npx prisma studio
# Opens GUI at http://localhost:5555
```

---

## ✅ Deployment Checklist

### Before Deploying

- [ ] All environment variables configured
- [ ] Database schema migrated
- [ ] At least one admin user created
- [ ] CORS configured in backend for your frontend domain
- [ ] Supabase Auth configured
- [ ] Test local build: `cd mobile && npx expo export:web`

### After Deploying

- [ ] Test user signup/login
- [ ] Test creating an event (admin)
- [ ] Test RSVP to event (user)
- [ ] Test responsive design on mobile browser
- [ ] Check browser console for errors
- [ ] Verify API calls are working

---

## 🌐 Custom Domain Setup

### Netlify

1. Domain settings → Add custom domain
2. Follow DNS configuration instructions
3. Enable HTTPS (automatic with Let's Encrypt)

### Vercel

1. Project settings → Domains
2. Add domain and configure DNS
3. HTTPS is automatic

---

## 📊 Monitoring & Logs

### Frontend

- **Netlify**: Functions tab for logs
- **Vercel**: Deployments tab for build logs

### Backend

- **Railway**: View logs in dashboard
- **Render**: Logs tab in dashboard

---

## 🚨 Troubleshooting

### "Network Request Failed"

- Check API URL is correct in environment variables
- Ensure CORS is configured in backend
- Check backend is actually running

### "Unauthorized" Errors

- Verify Supabase keys are correct
- Check JWT_SECRET matches between services
- Ensure user has correct role for admin access

### Build Fails

- Clear caches: `cd mobile && rm -rf .expo node_modules web-build && npm install`
- Check Node version is 18+
- Ensure all dependencies are installed

### Admin Tab Not Showing

- Check user role in database is set to `ADMIN` or `SUPER_ADMIN`
- Clear app cache and reload
- Check `/auth/me` endpoint returns correct role

---

## 📚 Additional Resources

- [Expo Web Deployment](https://docs.expo.dev/distribution/publishing-websites/)
- [Railway Documentation](https://docs.railway.app/)
- [Netlify Documentation](https://docs.netlify.com/)
- [Supabase Documentation](https://supabase.com/docs)
- [Prisma Documentation](https://www.prisma.io/docs)

---

## 🆘 Support

If you encounter issues:

1. Check the troubleshooting section above
2. Review application logs in your hosting dashboard
3. Check browser console for frontend errors
4. Verify all environment variables are set correctly

---

## 📦 Project Structure

```
scene-together/
├── api/                    # Express backend
│   ├── src/
│   ├── prisma/
│   └── package.json
├── mobile/                 # Expo app (mobile + web)
│   ├── src/
│   ├── app.json
│   ├── netlify.toml       # Netlify config
│   ├── vercel.json        # Vercel config
│   └── package.json
└── DEPLOYMENT.md          # This file
```

---

**Happy Deploying! 🚀**
